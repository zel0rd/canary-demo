worker_processes auto;
events { worker_connections 1024; }

http {
  upstream stable_upstream {
    server web-v1:3000;
  }
  upstream canary_upstream {
    server web-v2:3000;
  }

  map $cookie_canary $force_canary {
    "1" 1;
    default 0;
  }

  split_clients "${remote_addr}${http_user_agent}${request_id}" $split_bucket {
    10%     canary;
    *       stable;
  }

  map "$force_canary:$split_bucket" $target_upstream {
    "1:canary"  canary_upstream;   # 쿠키 있고 split canary → canary
    "1:stable"  canary_upstream;   # 쿠키 있고 split stable → canary (즉 쿠키 있으면 무조건)
    "0:canary"  canary_upstream;   # 쿠키 없고 추첨 당첨 → canary
    default     stable_upstream;   # 그 외 → stable
  }

  map "$target_upstream" $set_canary_cookie {
    canary_upstream "canary=1; Path=/; Max-Age=604800";
    default         "";
  }

  log_format main '$remote_addr - canary=$force_canary/$split_bucket '
                  '- $target_upstream - $status - "$request"';
  access_log /var/log/nginx/access.log main;

  server {
    listen 80;
    location / {
      proxy_pass http://$target_upstream;
      if ($set_canary_cookie != "") {
        add_header Set-Cookie "$set_canary_cookie";
      }
    }
    location = /health { return 200 "ok"; }
  }
}
